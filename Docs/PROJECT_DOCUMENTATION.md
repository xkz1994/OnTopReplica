# OnTopReplica é¡¹ç›®æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

**OnTopReplica** æ˜¯ä¸€ä¸ª Windows æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œå¯ä»¥åˆ›å»ºä»»æ„çª—å£çš„å®æ—¶"å…‹éš†"å‰¯æœ¬ï¼Œå¹¶ä½¿å…¶ä¿æŒåœ¨å±å¹•æœ€å‰ç«¯æ˜¾ç¤ºã€‚è¯¥åº”ç”¨ç¨‹åºåˆ©ç”¨ Windows DWM (Desktop Window Manager) ç¼©ç•¥å›¾ API æ¥å®ç°çª—å£çš„å®æ—¶é•œåƒåŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½

**åˆ›å»ºçª—å£çš„å®æ—¶å…‹éš†å‰¯æœ¬å¹¶ä¿æŒåœ¨æœ€é¡¶å±‚æ˜¾ç¤º**

è¿™è®©ä½ å¯ä»¥åœ¨å·¥ä½œæ—¶å§‹ç»ˆçœ‹åˆ°å¦ä¸€ä¸ªçª—å£çš„å†…å®¹ï¼Œéå¸¸é€‚åˆç›‘æ§åå°è¿›ç¨‹ã€è¾¹å·¥ä½œè¾¹çœ‹è§†é¢‘ã€å¤„ç†å¤æ‚çš„å¤šçª—å£æ¸¸æˆæˆ–å·¥å…·ç­‰åœºæ™¯ã€‚

### åŠŸèƒ½è¯¦è§£

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ğŸªŸ **çª—å£å…‹éš†** | é€‰æ‹©ä»»æ„çª—å£ï¼Œåˆ›å»ºå®æ—¶æ›´æ–°çš„å…‹éš†å‰¯æœ¬ï¼Œå§‹ç»ˆæ˜¾ç¤ºåœ¨å…¶ä»–çª—å£ä¹‹ä¸Š |
| ğŸ“ **åŒºåŸŸé€‰æ‹©** | åªå…‹éš†çª—å£çš„ç‰¹å®šåŒºåŸŸï¼ˆå¦‚è§†é¢‘æ’­æ”¾åŒºåŸŸï¼‰ï¼Œæ”¯æŒç›¸å¯¹åæ ‡ |
| ğŸ’¾ **åŒºåŸŸå­˜å‚¨** | ä¿å­˜å¸¸ç”¨åŒºåŸŸé…ç½®ï¼Œä¸‹æ¬¡å¿«é€Ÿé€‰ç”¨ |
| ğŸ“ **è‡ªåŠ¨è°ƒæ•´å¤§å°** | æ”¯æŒåŸå§‹å¤§å°ã€1/2 å°ºå¯¸ã€1/4 å°ºå¯¸å’Œå…¨å±æ¨¡å¼ |
| ğŸ“ **ä½ç½®é”å®š** | é”å®šå…‹éš†çª—å£åˆ°å±å¹•å››è§’ä»»æ„ä½ç½® |
| ğŸ” **é€æ˜åº¦è°ƒèŠ‚** | è‡ªå®šä¹‰å…‹éš†çª—å£çš„é€æ˜åº¦ï¼Œå®ç°åŠé€æ˜æ•ˆæœ |
| ğŸ–±ï¸ **ç‚¹å‡»è½¬å‘** | ç‚¹å‡»å…‹éš†çª—å£æ—¶ï¼Œæ“ä½œä¼šä¼ é€’åˆ°åŸçª—å£ï¼Œå®ç°äº¤äº’ |
| ğŸ‘† **ç‚¹å‡»ç©¿é€** | å…‹éš†çª—å£å˜æˆçº¯è¦†ç›–å±‚ï¼Œé¼ æ ‡ç‚¹å‡»ç©¿é€åˆ°ä¸‹æ–¹çª—å£ |
| ğŸ”„ **åˆ†ç»„åˆ‡æ¢** | åœ¨å¤šä¸ªçª—å£é—´è‡ªåŠ¨åˆ‡æ¢æ˜¾ç¤º |

### å…¸å‹ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æè¿° |
|------|------|
| ğŸ“º **è¾¹å·¥ä½œè¾¹çœ‹è§†é¢‘** | å…‹éš†è§†é¢‘æ’­æ”¾å™¨çª—å£ï¼Œæ”¾åœ¨å±å¹•è§’è½ï¼Œè¾¹å·¥ä½œè¾¹è§‚çœ‹ |
| ğŸ® **æ¸¸æˆç›‘æ§** | å…‹éš†æ¸¸æˆä¸­çš„å°åœ°å›¾ã€çŠ¶æ€æ æˆ–èŠå¤©çª—å£ |
| ğŸ“Š **æ•°æ®ç›‘æ§** | ç›‘æ§åå°è¿è¡Œçš„ç¨‹åºè¾“å‡ºã€æ—¥å¿—æˆ–ä»ªè¡¨ç›˜ |
| ğŸ’¬ **å³æ—¶é€šè®¯** | ä¿æŒèŠå¤©çª—å£å§‹ç»ˆå¯è§ï¼ŒåŒæ—¶è¿›è¡Œå…¶ä»–å·¥ä½œ |
| ğŸ–¥ï¸ **å¤šä»»åŠ¡å¤„ç†** | åœ¨å¤æ‚çš„å¤šçª—å£ç¯å¢ƒä¸­ä¿æŒå…³é”®ä¿¡æ¯å¯è§ |

---

## æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£

### 1. çª—å£å…‹éš† (DWM Thumbnail)

**ä»£ç ä½ç½®**ï¼š[src/OnTopReplica/ThumbnailPanel.cs](src/OnTopReplica/ThumbnailPanel.cs)

**å®ç°åŸç†**ï¼š
åˆ©ç”¨ Windows DWM (Desktop Window Manager) çš„ Thumbnail API åˆ›å»ºçª—å£çš„å®æ—¶é•œåƒã€‚

```csharp
// ThumbnailPanel.cs - æ ¸å¿ƒæ–¹æ³•
public void SetThumbnailHandle(WindowHandle handle, ThumbnailRegion region) {
    // å…³é—­ç°æœ‰ç¼©ç•¥å›¾
    if (_thumbnail != null && !_thumbnail.IsInvalid) {
        _thumbnail.Close();
    }
    
    // æ³¨å†Œæ–°çš„ DWM ç¼©ç•¥å›¾å…³ç³»
    _thumbnail = DwmManager.Register(owner, handle.Handle);
    
    // è®¾ç½®åŒºåŸŸå¹¶åˆ·æ–°
    _currentRegion = region;
    UpdateThubmnail();
}
```

**å…³é”® API**ï¼š
- `DwmManager.Register()` - æ³¨å†Œç¼©ç•¥å›¾å…³ç³»
- `_thumbnail.Update()` - æ›´æ–°ç¼©ç•¥å›¾çš„ç›®æ ‡åŒºåŸŸã€æºåŒºåŸŸå’Œé€æ˜åº¦

---

### 2. å¤åˆ¶åˆ°å‰ªè´´æ¿

**ä»£ç ä½ç½®**ï¼š[src/OnTopReplica/MainForm_Features.cs](src/OnTopReplica/MainForm_Features.cs)

**å®ç°åŸç†**ï¼š
ä½¿ç”¨ Windows `PrintWindow` API æ•è·æºçª—å£çš„æˆªå›¾ï¼Œå¦‚æœè®¾ç½®äº†åŒºåŸŸåˆ™è£å‰ªåˆ°é€‰å®šåŒºåŸŸï¼Œç„¶åå¤åˆ¶åˆ°ç³»ç»Ÿå‰ªè´´æ¿ã€‚

**å¿«æ·é”®**ï¼š`Ctrl+C`

```csharp
// MainForm_Features.cs - å¤åˆ¶åˆ°å‰ªè´´æ¿
public void CopyThumbnailToClipboard() {
    // è·å–æºçª—å£çš„æˆªå›¾
    var bitmap = CaptureWindow(CurrentThumbnailWindowHandle.Handle);
    
    // å¦‚æœè®¾ç½®äº†åŒºåŸŸï¼Œåˆ™è£å‰ªåˆ°é€‰å®šåŒºåŸŸ
    if (_thumbnailPanel.SelectedRegion != null && _thumbnailPanel.ConstrainToRegion) {
        var regionRect = region.ComputeRegionRectangle(sourceSize);
        var croppedBitmap = bitmap.Clone(regionRect, bitmap.PixelFormat);
        bitmap = croppedBitmap;
    }
    
    Clipboard.SetImage(bitmap);  // å¤åˆ¶åˆ°å‰ªè´´æ¿
}

// MainForm.cs - å¿«æ·é”®å¤„ç†
protected override void OnKeyUp(KeyEventArgs e) {
    //CTRL+C - Copy to clipboard
    if (e.Modifiers == Keys.Control && e.KeyCode == Keys.C) {
        e.Handled = true;
        CopyThumbnailToClipboard();
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
- å³é”®èœå• â†’ é«˜çº§ â†’ å¤åˆ¶åˆ°å‰ªè´´æ¿
- å¿«æ·é”® `Ctrl+C`

---

### 3. åŒºåŸŸé€‰æ‹©

**ä»£ç ä½ç½®**ï¼š
- [src/OnTopReplica/ThumbnailPanel.cs](src/OnTopReplica/ThumbnailPanel.cs) - åŒºåŸŸç»˜åˆ¶
- [src/OnTopReplica/ThumbnailRegion.cs](src/OnTopReplica/ThumbnailRegion.cs) - åŒºåŸŸæ•°æ®æ¨¡å‹

**å®ç°åŸç†**ï¼š
ç”¨æˆ·é€šè¿‡é¼ æ ‡æ‹–æ‹½åœ¨å…‹éš†çª—å£ä¸Šç»˜åˆ¶çŸ©å½¢åŒºåŸŸï¼Œç³»ç»Ÿå°†å®¢æˆ·ç«¯åæ ‡è½¬æ¢ä¸ºæºçª—å£åæ ‡ã€‚

```csharp
// ThumbnailPanel.cs - åŒºåŸŸç»˜åˆ¶
protected void RaiseRegionDrawn(Point start, Point end) {
    // è®¡ç®—è¾¹ç•Œå¹¶è£å‰ª
    int left = Math.Max(0, Math.Min(start.X, end.X));
    int right = Math.Min(_thumbnailSize.Width, Math.Max(start.X, end.X));
    
    // è½¬æ¢ä¸ºç¼©ç•¥å›¾åæ ‡
    var startPoint = ClientToThumbnail(new Point(left, top));
    var endPoint = ClientToThumbnail(new Point(right, bottom));
    
    OnRegionDrawn(new Rectangle(startPoint.X, startPoint.Y, ...));
}
```

**åŒºåŸŸæ¨¡å¼**ï¼š
- **ç»å¯¹æ¨¡å¼**ï¼šå›ºå®šåƒç´ åæ ‡
- **ç›¸å¯¹æ¨¡å¼**ï¼šç›¸å¯¹äºçª—å£è¾¹æ¡†çš„ Padding å€¼ï¼ˆé€‚åº”çª—å£å¤§å°å˜åŒ–ï¼‰

---

### 3. ç‚¹å‡»è½¬å‘

**ä»£ç ä½ç½®**ï¼š
- [src/OnTopReplica/MainForm_Features.cs](src/OnTopReplica/MainForm_Features.cs) - åŠŸèƒ½å¼€å…³
- [src/OnTopReplica/ThumbnailPanel.cs](src/OnTopReplica/ThumbnailPanel.cs) - ç‚¹å‡»æ£€æµ‹

**å®ç°åŸç†**ï¼š
æ•è·å…‹éš†çª—å£ä¸Šçš„ç‚¹å‡»äº‹ä»¶ï¼Œè®¡ç®—å¯¹åº”æºçª—å£çš„åæ ‡ï¼Œç„¶åå‘æºçª—å£å‘é€æ¨¡æ‹Ÿè¾“å…¥æ¶ˆæ¯ã€‚

```csharp
// MainForm_Features.cs - å¯ç”¨ç‚¹å‡»è½¬å‘
public bool ClickForwardingEnabled {
    get { return _thumbnailPanel.ReportThumbnailClicks; }
    set { _thumbnailPanel.ReportThumbnailClicks = value; }
}

// ThumbnailPanel.cs - ç‚¹å‡»äº‹ä»¶å¤„ç†
protected override void OnMouseClick(MouseEventArgs e) {
    if (ReportThumbnailClicks) {
        // è½¬æ¢åæ ‡å¹¶è§¦å‘äº‹ä»¶
        OnCloneClick(ClientToThumbnail(e.Location), e.Button, false);
    }
}

// åæ ‡è½¬æ¢ï¼šå®¢æˆ·ç«¯ â†’ æºçª—å£
protected Point ClientToThumbnail(Point position) {
    position.X -= _padWidth;  // è¡¥å¿å†…è¾¹è·
    position.Y -= _padHeight;
    
    // è®¡ç®—æ¯”ä¾‹ä½ç½®
    PointF proportionalPosition = new PointF(
        (float)position.X / _thumbnailSize.Width,
        (float)position.Y / _thumbnailSize.Height
    );
    
    // è¿”å›æºçª—å£ä¸­çš„å®é™…åƒç´ ä½ç½®
    return new Point(
        (int)(proportionalPosition.X * source.Width) + offset.X,
        (int)(proportionalPosition.Y * source.Height) + offset.Y
    );
}
```

---

### 4. ç‚¹å‡»ç©¿é€

**ä»£ç ä½ç½®**ï¼š[src/OnTopReplica/MainForm_Features.cs](src/OnTopReplica/MainForm_Features.cs)

**å®ç°åŸç†**ï¼š
é€šè¿‡è®¾ç½®çª—ä½“çš„ `TransparencyKey` å±æ€§ï¼Œä½¿ç‰¹å®šé¢œè‰²åŒºåŸŸå¯¹é¼ æ ‡äº‹ä»¶é€æ˜ã€‚

```csharp
// MainForm_Features.cs
public bool ClickThroughEnabled {
    get { return _clickThrough; }
    set {
        // è®¾ç½®é€æ˜é”®é¢œè‰²ä¸ºé»‘è‰²ï¼Œä½¿çª—å£å†…å®¹åŒºåŸŸå¯ç©¿é€
        TransparencyKey = (value) ? Color.Black : DefaultNonClickTransparencyKey;
        
        if (value) {
            // é‡æ–°å¼ºåˆ¶ç½®é¡¶
            TopMost = false;
            this.Activate();
            TopMost = true;
        }
        _clickThrough = value;
    }
}
```

**é™„åŠ åŠŸèƒ½**ï¼šå½“é¼ æ ‡æ‚¬åœåœ¨å…¨é€æ˜çš„ç‚¹å‡»ç©¿é€çª—å£ä¸Šæ—¶ï¼Œçª—å£ä¼šä¸´æ—¶å˜ä¸ºåŠé€æ˜ï¼Œæ–¹ä¾¿ç”¨æˆ·è¯†åˆ«ã€‚

---

### 5. ä½ç½®é”å®š

**ä»£ç ä½ç½®**ï¼š
- [src/OnTopReplica/MainForm_Features.cs](src/OnTopReplica/MainForm_Features.cs) - é”å®šé€»è¾‘
- [src/OnTopReplica/ScreenPosition.cs](src/OnTopReplica/ScreenPosition.cs) - ä½ç½®è®¡ç®—

**å®ç°åŸç†**ï¼š
å®šä¹‰å±å¹•ä½ç½®æšä¸¾ï¼ˆå·¦ä¸Šã€å³ä¸Šã€å·¦ä¸‹ã€å³ä¸‹ã€å±…ä¸­ï¼‰ï¼Œè®¡ç®—ç›®æ ‡ä½ç½®å¹¶ç§»åŠ¨çª—ä½“ã€‚

```csharp
// ScreenPosition.cs - ä½ç½®æšä¸¾
enum ScreenPosition {
    TopLeft, TopRight, BottomLeft, BottomRight, Center
}

// è®¡ç®—å±å¹•ä½ç½®åæ ‡
public static Point ResolveScreenPosition(this Screen screen, ScreenPosition position) {
    var rect = screen.WorkingArea;
    switch (position) {
        case ScreenPosition.TopLeft:
            return new Point(rect.X, rect.Y);
        case ScreenPosition.BottomRight:
            return new Point(rect.X + rect.Width, rect.Y + rect.Height);
        // ...
    }
}

// MainForm_Features.cs - åº”ç”¨ä½ç½®é”å®š
public ScreenPosition? PositionLock {
    set {
        if (value != null)
            this.SetScreenPosition(value.Value);
        _positionLock = value;
    }
}
```

---

### 6. å…¨å±æ¨¡å¼

**ä»£ç ä½ç½®**ï¼š[src/OnTopReplica/FullscreenFormManager.cs](src/OnTopReplica/FullscreenFormManager.cs)

**å®ç°åŸç†**ï¼š
ä¿å­˜å½“å‰çª—ä½“çŠ¶æ€ï¼Œç„¶åç§»é™¤è¾¹æ¡†å¹¶è°ƒæ•´çª—ä½“å¤§å°ä»¥å¡«å……å±å¹•ã€‚

```csharp
// FullscreenFormManager.cs
public void SwitchFullscreen(FullscreenMode mode) {
    // ä¿å­˜å½“å‰çŠ¶æ€
    _preFullscreenLocation = _mainForm.Location;
    _preFullscreenSize = _mainForm.ClientSize;
    _preFullscreenBorderStyle = _mainForm.FormBorderStyle;
    
    // åˆ‡æ¢åˆ°å…¨å±
    _mainForm.FormBorderStyle = FormBorderStyle.None;
    MoveToFullscreenMode(mode);
}

private void MoveToFullscreenMode(FullscreenMode mode) {
    var currentScreen = Screen.FromControl(_mainForm);
    switch (mode) {
        case FullscreenMode.Standard:      // å·¥ä½œåŒºï¼ˆä¸å«ä»»åŠ¡æ ï¼‰
            size = currentScreen.WorkingArea.Size;
            break;
        case FullscreenMode.Fullscreen:    // æ•´ä¸ªå±å¹•
            size = currentScreen.Bounds.Size;
            break;
        case FullscreenMode.AllScreens:    // æ‰€æœ‰æ˜¾ç¤ºå™¨
            size = SystemInformation.VirtualScreen.Size;
            break;
    }
    _mainForm.Size = size;
}
```

---

### 7. é€æ˜åº¦è°ƒèŠ‚

**ä»£ç ä½ç½®**ï¼š[src/OnTopReplica/MainForm_MenuEvents.cs](src/OnTopReplica/MainForm_MenuEvents.cs)

**å®ç°åŸç†**ï¼š
é€šè¿‡ Windows Forms çš„ `Form.Opacity` å±æ€§è®¾ç½®çª—ä½“é€æ˜åº¦ï¼ˆ0.0 - 1.0ï¼‰ã€‚

```csharp
// è®¾ç½®é€æ˜åº¦ï¼ˆç¤ºä¾‹ï¼‰
this.Opacity = 0.75;  // 75% ä¸é€æ˜åº¦
```

---

### 8. åˆ†ç»„åˆ‡æ¢

**ä»£ç ä½ç½®**ï¼š
- [src/OnTopReplica/SidePanels/GroupSwitchPanel.cs](src/OnTopReplica/SidePanels/GroupSwitchPanel.cs) - UI é¢æ¿
- [src/OnTopReplica/MessagePumpProcessors/GroupSwitchManager.cs](src/OnTopReplica/MessagePumpProcessors/) - åˆ‡æ¢é€»è¾‘

**å®ç°åŸç†**ï¼š
ç”¨æˆ·é€‰æ‹©å¤šä¸ªçª—å£ç»„æˆä¸€ä¸ªç»„ï¼Œå½“ç”¨æˆ·æ¿€æ´»ç»„å†…ä»»ä¸€çª—å£æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢æ˜¾ç¤ºè¯¥çª—å£çš„å…‹éš†ã€‚

```csharp
// GroupSwitchPanel.cs - å¯ç”¨åˆ†ç»„åˆ‡æ¢
public override void OnClosing(MainForm form) {
    if (_enableOnClose && listWindows.SelectedItems.Count > 0) {
        List<WindowHandle> ret = new List<WindowHandle>();
        foreach (ListViewItem i in listWindows.SelectedItems) {
            ret.Add((WindowHandle)i.Tag);
        }
        form.SetThumbnailGroup(ret);  // è®¾ç½®çª—å£ç»„
    }
}
```

---

### ç³»ç»Ÿè¦æ±‚

- Microsoft Windows Vista æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆä½¿ç”¨åŸç”Ÿ DWM ç¼©ç•¥å›¾ï¼‰
- Microsoft .NET Framework 4.7
- æ¡Œé¢ç»„åˆï¼ˆWindows Aeroï¼‰å·²å¯ç”¨

---

## é¡¹ç›®ç»“æ„

```
OnTopReplica/
â”œâ”€â”€ Docs/                          # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ Graphics/                      # å›¾å½¢èµ„æº
â”‚   â”œâ”€â”€ Raster/                   # ä½å›¾èµ„æº
â”‚   â””â”€â”€ Vector/                   # çŸ¢é‡å›¾èµ„æº
â”œâ”€â”€ Installer/                     # å®‰è£…ç¨‹åºè„šæœ¬
â”‚   â”œâ”€â”€ script.nsi                # NSIS å®‰è£…è„šæœ¬
â”‚   â”œâ”€â”€ DotNet.nsh                # .NET æ£€æµ‹è„šæœ¬
â”‚   â””â”€â”€ PostInstaller/            # å®‰è£…åå¤„ç†ç¨‹åº
â”œâ”€â”€ OriginalAssets/               # åŸå§‹è®¾è®¡èµ„æº
â”œâ”€â”€ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ OnTopReplica.sln          # è§£å†³æ–¹æ¡ˆæ–‡ä»¶
â”‚   â”œâ”€â”€ OnTopReplica/             # ä¸»é¡¹ç›®
â”‚   â”œâ”€â”€ Installer/                # å®‰è£…ç¨‹åºé¡¹ç›®
â”‚   â””â”€â”€ packages/                 # NuGet åŒ…
â”œâ”€â”€ CODE_OF_CONDUCT.md            # è¡Œä¸ºå‡†åˆ™
â”œâ”€â”€ LICENSE                       # è®¸å¯è¯ (MS-RL)
â””â”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. å…¥å£ç‚¹ä¸åº”ç”¨ç¨‹åºåˆå§‹åŒ–

#### `Program.cs`
åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ï¼Œè´Ÿè´£ï¼š
- è®¾ç½®åº”ç”¨ç¨‹åºè·¯å¾„ (`AppPaths.SetupPaths()`)
- åˆå§‹åŒ–å¹³å°æ”¯æŒæ£€æŸ¥
- å¤„ç†å‘½ä»¤è¡Œå‚æ•°
- åŠ è½½è¯­è¨€è®¾ç½®
- åˆ›å»ºå¹¶è¿è¡Œä¸»çª—ä½“
- æŒä¹…åŒ–ç”¨æˆ·è®¾ç½®

```csharp
// æ ¸å¿ƒå¯åŠ¨æµç¨‹
AppPaths.SetupPaths();           // è®¾ç½®è·¯å¾„
Platform = PlatformSupport.Create(); // åˆå§‹åŒ–å¹³å°æ”¯æŒ
Platform.CheckCompatibility();   // å…¼å®¹æ€§æ£€æŸ¥
Application.Run(_mainForm);      // è¿›å…¥ä¸»å¾ªç¯
```

### 2. ä¸»çª—ä½“æ¶æ„

ä¸»çª—ä½“é‡‡ç”¨**åˆ†éƒ¨ç±» (Partial Class)** è®¾è®¡æ¨¡å¼ï¼Œå°†åŠŸèƒ½åˆ†æ•£åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ï¼š

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `MainForm.cs` | æ ¸å¿ƒé€»è¾‘ã€äº‹ä»¶å¤„ç†ã€åˆå§‹åŒ– |
| `MainForm.Designer.cs` | WinForms è®¾è®¡å™¨ç”Ÿæˆçš„ UI ä»£ç  |
| `MainForm_Features.cs` | åŠŸèƒ½å®ç°ï¼ˆç‚¹å‡»è½¬å‘ã€ç‚¹å‡»ç©¿é€ã€é€æ˜åº¦ç­‰ï¼‰ |
| `MainForm_Gui.cs` | GUI ç›¸å…³æ–¹æ³• |
| `MainForm_MenuEvents.cs` | èœå•äº‹ä»¶å¤„ç† |
| `MainForm_ChildForms.cs` | å­çª—ä½“ç®¡ç† |

#### `MainForm.cs`
ç»§æ‰¿è‡ª `AspectRatioForm`ï¼Œä¸»è¦ç»„ä»¶ï¼š
- `ThumbnailPanel _thumbnailPanel` - æ˜¾ç¤ºç¼©ç•¥å›¾çš„é¢æ¿
- `MessagePumpManager _msgPumpManager` - æ¶ˆæ¯æ³µç®¡ç†
- `WindowListMenuManager _windowListManager` - çª—å£åˆ—è¡¨ç®¡ç†
- `FullscreenFormManager FullscreenManager` - å…¨å±ç®¡ç†

### 3. ç¼©ç•¥å›¾ç³»ç»Ÿ

#### `ThumbnailPanel.cs`
æ ¸å¿ƒç¼©ç•¥å›¾æ˜¾ç¤ºæ§ä»¶ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
- ä½¿ç”¨ DWM Thumbnail API æ˜¾ç¤ºçª—å£ç¼©ç•¥å›¾
- æ”¯æŒåŒºåŸŸé€‰æ‹©å’Œçº¦æŸ
- é¼ æ ‡åŒºåŸŸç»˜åˆ¶æ¨¡å¼
- ç‚¹å‡»äº‹ä»¶æŠ¥å‘Š

#### `ThumbnailRegion.cs`
ç®¡ç†ç¼©ç•¥å›¾åŒºåŸŸçš„ç±»ï¼Œæ”¯æŒï¼š
- ç›¸å¯¹åæ ‡è®¡ç®—
- åŒºåŸŸè¾¹ç•Œå®šä¹‰
- åŒºåŸŸå­˜å‚¨å’Œæ¢å¤

#### `StoredRegion.cs` / `StoredRegionArray.cs`
ç”¨äºä¿å­˜å’Œç®¡ç†ç”¨æˆ·å®šä¹‰çš„åŒºåŸŸï¼š
- åŒºåŸŸæŒä¹…åŒ–
- åŒºåŸŸæ¯”è¾ƒå’Œæ’åº

### 4. çª—å£ç®¡ç†

#### `WindowHandle.cs`
çª—å£å¥æŸ„å°è£…ç±»ï¼š
- ä¿å­˜çª—å£å¥æŸ„ (HWND)
- è·å–çª—å£æ ‡é¢˜
- åŠ è½½çª—å£å›¾æ ‡
- è·å–çª—å£ç±»å

#### `WindowListMenuManager.cs`
ç®¡ç†çª—å£é€‰æ‹©èœå•ï¼š
- ä½¿ç”¨ `TaskWindowSeeker` æ‰«æå¯ç”¨çª—å£
- å¡«å……å³é”®èœå•
- å¤„ç†çª—å£é€‰æ‹©äº‹ä»¶

### 5. å¹³å°å…¼å®¹å±‚

#### `PlatformSupport.cs`
æŠ½è±¡åŸºç±»ï¼Œæ ¹æ®æ“ä½œç³»ç»Ÿç‰ˆæœ¬åˆ›å»ºå…·ä½“å®ç°ï¼š

```csharp
// æ”¯æŒçš„å¹³å°
â”œâ”€â”€ WindowsVista.cs     // Windows Vista
â”œâ”€â”€ WindowsSeven.cs     // Windows 7
â”œâ”€â”€ WindowsEight.cs     // Windows 8/8.1/10/11
â”œâ”€â”€ WindowsXp.cs        // Windows XP (ä¸å®Œå…¨æ”¯æŒ)
â””â”€â”€ Other.cs            // å…¶ä»–å¹³å°
```

åŠŸèƒ½ï¼š
- å…¼å®¹æ€§æ£€æŸ¥
- çª—ä½“åˆå§‹åŒ–
- çª—ä½“éšè—/æ¢å¤
- ä»»åŠ¡æ äº¤äº’

### 6. åŸç”Ÿ API å°è£…

`Native/` ç›®å½•åŒ…å« Windows API å°è£…ï¼š

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `WindowMethods.cs` | çª—å£æ“ä½œæ–¹æ³• |
| `MessagingMethods.cs` | Windows æ¶ˆæ¯å¤„ç† |
| `HotKeyMethods.cs` | çƒ­é”®æ³¨å†Œ |
| `InputMethods.cs` | è¾“å…¥æ¨¡æ‹Ÿ |
| `HookMethods.cs` | é’©å­ç›¸å…³ |
| `WindowManagerMethods.cs` | çª—å£ç®¡ç†å™¨æ–¹æ³• |
| `WM.cs` | Windows æ¶ˆæ¯å¸¸é‡ |

### 7. ä¾§è¾¹é¢æ¿ç³»ç»Ÿ

`SidePanels/` ç›®å½•åŒ…å«å¯æ»‘å‡ºçš„ä¾§è¾¹é¢æ¿ï¼š

| é¢æ¿ | åŠŸèƒ½ |
|------|------|
| `AboutPanel.cs` | å…³äºä¿¡æ¯ |
| `OptionsPanel.cs` | é€‰é¡¹è®¾ç½® |
| `RegionPanel.cs` | åŒºåŸŸç¼–è¾‘ |
| `GroupSwitchPanel.cs` | åˆ†ç»„åˆ‡æ¢ |

### 8. å‘½ä»¤è¡Œé€‰é¡¹

`StartupOptions/` ç›®å½•å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼š
- `Factory.cs` - è§£æå‘½ä»¤è¡Œå‚æ•°
- `Options.cs` - é€‰é¡¹æ•°æ®ç±»
- å„ç§å€¼è½¬æ¢å™¨ (`SizeConverter.cs`, `RectangleConverter.cs` ç­‰)

### 9. æ¶ˆæ¯æ³µå¤„ç†

#### `MessagePumpManager.cs` / `MessagePumpProcessors/`
å¤„ç† Windows æ¶ˆæ¯å¾ªç¯ï¼š
- çƒ­é”®å¤„ç†
- ç³»ç»Ÿæ¶ˆæ¯æ‹¦æˆª
- è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†

### 10. å…¨å±ç®¡ç†

#### `FullscreenFormManager.cs`
ç®¡ç†å…¨å±æ¨¡å¼ï¼š
- ä¿å­˜/æ¢å¤çª—ä½“çŠ¶æ€
- å¤šæ˜¾ç¤ºå™¨æ”¯æŒ
- å…¨å±æ¨¡å¼åˆ‡æ¢

---

## å¤šè¯­è¨€æ”¯æŒ

é¡¹ç›®æ”¯æŒå¤šç§è¯­è¨€ï¼Œèµ„æºæ–‡ä»¶ä½äºé¡¹ç›®æ ¹ç›®å½•ï¼š

| è¯­è¨€ | æ–‡ä»¶ |
|------|------|
| è‹±è¯­ (é»˜è®¤) | `Strings.resx` |
| ç®€ä½“ä¸­æ–‡ | `Strings.zh-Hans.resx` |
| ç¹ä½“ä¸­æ–‡ | `Strings.zh-TW.resx` |
| å¾·è¯­ | `Strings.de.resx` |
| æ—¥è¯­ | `Strings.ja-JP.resx` |
| ä¿„è¯­ | `Strings.ru.resx` |
| æ›´å¤š... | `Strings.*.resx` |

---

## å…³é”®æŠ€æœ¯ç‚¹

### DWM Thumbnail API
åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½ä¾èµ–äº Windows Desktop Window Manager çš„ç¼©ç•¥å›¾ APIï¼š
- `DwmRegisterThumbnail` - æ³¨å†Œç¼©ç•¥å›¾å…³ç³»
- `DwmUpdateThumbnailProperties` - æ›´æ–°ç¼©ç•¥å›¾å±æ€§
- `DwmUnregisterThumbnail` - å–æ¶ˆæ³¨å†Œç¼©ç•¥å›¾

é€šè¿‡ `WindowsFormsAero` åº“å°è£…è°ƒç”¨ã€‚

### AspectRatioForm
è‡ªå®šä¹‰çª—ä½“åŸºç±»ï¼Œæ”¯æŒï¼š
- ä¿æŒå®½é«˜æ¯”è°ƒæ•´å¤§å°
- ç»ç’ƒæ•ˆæœè¾¹è·
- è‡ªå®šä¹‰è¾¹æ¡†æ ·å¼

### Click Forwarding
ç‚¹å‡»è½¬å‘åŠŸèƒ½é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š
1. æ•è·å…‹éš†çª—å£ä¸Šçš„ç‚¹å‡»ä½ç½®
2. è®¡ç®—å¯¹åº”åŸçª—å£çš„åæ ‡
3. å‘é€æ¨¡æ‹Ÿè¾“å…¥åˆ°åŸçª—å£

### Click-Through
ç‚¹å‡»ç©¿é€é€šè¿‡è®¾ç½® `TransparencyKey` å®ç°ï¼š
- å°†èƒŒæ™¯è‰²è®¾ä¸ºé€æ˜é”®é¢œè‰²
- Windows è‡ªåŠ¨å°†è¯¥é¢œè‰²åŒºåŸŸçš„ç‚¹å‡»ä¼ é€’åˆ°ä¸‹å±‚çª—å£

---

## æ„å»ºè¯´æ˜

### å‰ææ¡ä»¶
- Visual Studio 2017 æˆ–æ›´é«˜ç‰ˆæœ¬
- .NET Framework 4.7 SDK

### æ„å»ºæ­¥éª¤
1. æ‰“å¼€ `src/OnTopReplica.sln`
2. é€‰æ‹© `Debug` æˆ– `Release` é…ç½®
3. æ„å»ºè§£å†³æ–¹æ¡ˆ (Ctrl+Shift+B)

### è¾“å‡º
- å¯æ‰§è¡Œæ–‡ä»¶ï¼š`src/OnTopReplica/bin/{Configuration}/OnTopReplica.exe`

---

## ä¾èµ–é¡¹

| ä¾èµ– | ç”¨é€” |
|------|------|
| `WindowsFormsAero` | DWM API å°è£…ã€Aero ä¸»é¢˜æ§ä»¶ |
| `NDesk.Options` | å‘½ä»¤è¡Œå‚æ•°è§£æ |
| `System.Windows.Forms` | Windows Forms UI æ¡†æ¶ |
| `System.Drawing` | å›¾å½¢ç»˜åˆ¶ |

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ **MS-RL (Microsoft Reciprocal License)** è®¸å¯è¯ã€‚

---

## è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ· Pull Request

æ¬¢è¿æäº¤ Issue å’Œåé¦ˆï¼

---

## è·¯çº¿å›¾

- [x] æ›´æ–°åˆ°æœ€æ–° WindowsFormsAero ç‰ˆæœ¬
- [x] è¿ç§»åˆ° .NET 4.7
- [ ] æ”¹è¿›/æ·»åŠ é«˜ DPI æ”¯æŒ
- [ ] "å­˜å‚¨åœºæ™¯"åŠŸèƒ½
- [ ] è¿ç§»åˆ° Windows Store (Centennial)

---

*æ–‡æ¡£æœ€åæ›´æ–°ï¼š2026å¹´1æœˆ22æ—¥*
